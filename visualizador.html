<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #111; color: #d1d5db; font-family: 'Inter', sans-serif; }
    .conteudo-aula { padding: 20px; max-width: 900px; margin: 0 auto; }
    .conteudo-aula img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      display: block;
      margin: 20px 0;
    }
    .conteudo-aula h1 { font-size: 2rem; color: #00FFFF; margin-top: 1.5rem; font-weight: bold; }
    .conteudo-aula h2 { font-size: 1.5rem; color: #e5e7eb; margin-top: 1.5rem; border-left: 4px solid #00FFFF; padding-left: 10px; }
    .conteudo-aula p { margin-bottom: 1rem; line-height: 1.6; color: #d1d5db; }
    .conteudo-aula ul { list-style: disc; padding-left: 20px; margin-bottom: 1rem; }
    .conteudo-aula a { color: #3b82f6; text-decoration: underline; }
    .conteudo-aula header, .conteudo-aula footer { display: none !important; }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <header class="bg-[#1a1a1a] border-b border-[#333] sticky top-0 z-50 shadow-md">
    <div class="max-w-5xl mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img src="assets/img/JAVIS - LOGO COM REGISTRO (BRANCO) (2).webp" class="h-12">
        <div class="h-8 w-[1px] bg-gray-700 mx-2 hidden sm:block"></div>
        <div>
          <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Portal do Aluno</p>
          <h1 id="titulo-aula-top" class="text-sm md:text-base font-bold text-white leading-tight">Carregando aula...</h1>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-1">
    <div id="app" class="conteudo-aula fade-in">
      <div class="flex flex-col items-center justify-center h-64 text-gray-500">
        <i class="fas fa-circle-notch fa-spin text-3xl mb-4 text-[#00FFFF]"></i>
        <p>Carregando conteúdo...</p>
      </div>
    </div>
  </main>

  <footer class="bg-[#111] border-t border-[#222] py-8 mt-10">
    <p class="text-center text-gray-600 text-xs">© 2025 Javis Game Academy - Material Didático Exclusivo</p>
  </footer>

    <script>
        const API_URL = 'https://javisgames.onrender.com';

        const params = new URLSearchParams(window.location.search);
        const idAula = params.get('id');

        const token =
            localStorage.getItem('access_token') ||
            (window.parent ? window.parent.localStorage.getItem('access_token') : null);

        function extractFirstCanvaUrl(text) {
            const m = (text || "").match(/https?:\/\/(?:www\.)?canva\.com\/design\/[^\s"'<]+/i);
            return m ? m[0] : null;
        }

        function parseCanvaUrl(anyTextOrUrl) {
            const url = extractFirstCanvaUrl(anyTextOrUrl) || (anyTextOrUrl || "").trim();
            try {
                const u = new URL(url);
                const parts = u.pathname.split("/").filter(Boolean);
                const idx = parts.indexOf("design");
                if (idx === -1 || !parts[idx + 1]) return null;

                const designId = parts[idx + 1];

                // token opcional: /design/{id}/{token}/edit
                let token = null;
                const maybeToken = parts[idx + 2];
                if (maybeToken && !["view", "edit"].includes(maybeToken)) token = maybeToken;

                return { designId, token };
            } catch {
                return null;
            }
        }

        function isCanvaDesignLink(text) {
            return !!extractFirstCanvaUrl(text);
        }

            function buildCanvaViewEmbedUrl(anyTextOrUrl) {
            const p = parseCanvaUrl(anyTextOrUrl);
            if (!p) return null;
            const base = `https://www.canva.com/design/${p.designId}/${p.token ? p.token + "/" : ""}`;
            return `${base}view?embed`;
        }


        async function carregar() {
            const app = document.getElementById('app');
            const tituloTop = document.getElementById('titulo-aula-top');

            if (!idAula) {
                app.innerHTML = '<p>Aula não identificada.</p>';
                return;
            }

            try {
                const res = await fetch(`${API_URL}/admin/aula/${idAula}/conteudo`, {
                headers: { Authorization: `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Falha na requisição');

                const dados = await res.json();

                tituloTop.innerText = dados.titulo || 'Conteúdo da Aula';

                const conteudo = (dados.conteudo || dados.html || '').trim();
                if (!conteudo) {
                app.innerHTML = '<div class="text-center py-10"><p class="text-yellow-500">Conteúdo ainda não criado pelo professor.</p></div>';
                return;
                }

                // === CANVA: renderiza em iframe (SÓ VIEW EMBED) ===
                if (isCanvaDesignLink(conteudo)) {
                const embedUrl = buildCanvaViewEmbedUrl(conteudo);

                if (!embedUrl) {
                    app.innerHTML = `<div class="text-center py-10">
                    <p class="text-red-500">Link do Canva inválido.</p>
                    </div>`;
                    return;
                }

                app.innerHTML = `
                    <div class="w-full">
                    <iframe
                        src="${embedUrl}"
                        style="width:100%; height:80vh; border:0; border-radius:12px; background:#111;"
                        allowfullscreen
                        loading="lazy">
                    </iframe>
                    <p class="text-[10px] text-gray-500 mt-2">
                        Se der 403, confirme no Canva: Compartilhar → Acesso ao link → “Qualquer pessoa com o link” → “Pode visualizar”.
                    </p>
                    </div>
                `;
                return;
                }

                // === HTML normal (TinyMCE salvo) ===
                app.innerHTML = conteudo;

            } catch (e) {
                console.error(e);
                app.innerHTML = `
                <div class="text-center py-10">
                    <p class="text-red-500">Erro ao carregar aula.</p>
                    <button onclick="location.reload()" class="mt-4 bg-[#333] text-white px-4 py-2 rounded">Tentar Novamente</button>
                </div>`;
            }
        }



        carregar();
    </script>


</body>
</html>
